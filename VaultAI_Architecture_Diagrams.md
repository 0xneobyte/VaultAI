# VaultAI Architecture Diagrams

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Obsidian Application                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         VaultAI Plugin (Obsidian Editor)                 â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  GeminiChatbotPlugin (main.ts - 2600 lines)       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â—† Chat UI Management                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â—† Message Handling                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â—† Event Coordination                              â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚               â”‚                                         â”‚   â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚    â–¼          â–¼          â–¼          â–¼              â–¼    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚Chat â”‚  â”‚ GeminiS  â”‚ â”‚ Editor â”‚ â”‚ Settings â”‚  â”‚Modaâ”‚ â”‚   â”‚
â”‚  â”‚  â”‚ UI  â”‚  â”‚ ervice   â”‚ â”‚Context â”‚ â”‚   Tab    â”‚  â”‚ ls â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                â”‚                â”‚
         â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Obsidian â”‚      â”‚ Plugin  â”‚      â”‚Obsidianâ”‚
    â”‚ Vault   â”‚      â”‚ Data    â”‚      â”‚ Events â”‚
    â”‚(Files)  â”‚      â”‚(Settings)      â”‚(active-â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚leaf)   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚                                       â”‚
                          â–¼                                       â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Gemini API â”‚                      â”‚    Local     â”‚
                    â”‚ (generative) â”‚                      â”‚  File Index  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  (Future RAG)â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Flow - User Input to AI Response

```
USER INTERACTION
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chat Input (textarea)              â”‚
â”‚  User types message + hits Enter    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  handleMessage(message: string)     â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  1. Check API cooldown (1000ms)     â”‚
        â”‚  2. Extract @file references        â”‚
        â”‚  3. Get active file content         â”‚
        â”‚  4. Get editor context              â”‚
        â”‚  5. Build composite message         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Context Building                   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  Context = [                        â”‚
        â”‚    "--- Editor Context ---",        â”‚
        â”‚    "File: <active-file>",           â”‚
        â”‚    "Current line: <line-num>",      â”‚
        â”‚    "...",                           â”‚
        â”‚    "--- End Context ---",           â”‚
        â”‚    "\n\nUser question: <message>"   â”‚
        â”‚  ]                                  â”‚
        â”‚                                     â”‚
        â”‚  if (length > 30000)                â”‚
        â”‚    truncateAtParagraphBreak()       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Add User Message to UI             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  .gemini-message-user                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Show Typing Indicator              â”‚
        â”‚  .typing-indicator (animated dots)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Call GeminiService.sendMessage()   â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  â€¢ API: google generative ai        â”‚
        â”‚  â€¢ Model: gemini-1.5-flash          â”‚
        â”‚  â€¢ Max tokens: 1000                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  AI PROCESSES REQUEST               â”‚
        â”‚  (Google Servers)                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚
          â–¼                       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Response    â”‚         â”‚  Error   â”‚
    â”‚  Generated   â”‚         â”‚ Handling â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚                        â”‚
           â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Remove Typingâ”‚         â”‚ Categorize Error:â”‚
    â”‚ Indicator    â”‚         â”‚ â€¢ SAFETY         â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â€¢ RATE_LIMIT     â”‚
           â”‚                 â”‚ â€¢ AUTH_ERROR     â”‚
           â–¼                 â”‚ â€¢ SERVER_ERROR   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ Render       â”‚                â”‚
    â”‚ Markdown     â”‚                â–¼
    â”‚ Response     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ Show Error       â”‚
           â”‚                 â”‚ Message to User  â”‚
           â–¼                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
    â”‚ Add Bot      â”‚                â”‚
    â”‚ Message to   â”‚                â”‚
    â”‚ Chat History â”‚                â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
           â”‚                        â”‚
           â–¼                        â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Display Copy â”‚         â”‚ Done - Return to â”‚
    â”‚ Button       â”‚         â”‚ Chat Input       â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ If Insert    â”‚
    â”‚ Mode: Insert â”‚
    â”‚ at Cursor    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Save Message â”‚
    â”‚ to Session   â”‚
    â”‚ History      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Save Session â”‚
    â”‚ to Settings  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - Settings & Session Persistence

```
USER UPDATES SETTINGS
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ PluginSettingTab.display()
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Render Settings UI      â”‚
    â”‚ â€¢ API Key field         â”‚
    â”‚ â€¢ Custom Prompts list   â”‚
    â”‚ â€¢ Add/Edit/Delete btns  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User Changes Setting            â”‚
    â”‚ (e.g., enters new API key)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ onChange Callback Fired         â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ â€¢ Encrypt API key               â”‚
    â”‚ â€¢ Update settings object        â”‚
    â”‚ â€¢ Call saveSettings()           â”‚
    â”‚ â€¢ Re-init GeminiService         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ saveSettings()                  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ await this.saveData(settings)   â”‚
    â”‚                                 â”‚
    â”‚ Obsidian Plugin API:            â”‚
    â”‚ .obsidian/plugins/vault-ai/     â”‚
    â”‚ data.json                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Disk Storage                    â”‚
    â”‚ (Persistent Across Sessions)    â”‚
    â”‚                                 â”‚
    â”‚ {                               â”‚
    â”‚   "apiKey": "encrypted",        â”‚
    â”‚   "chatSessions": [...],        â”‚
    â”‚   "customPrompts": [...]        â”‚
    â”‚ }                               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ON PLUGIN LOAD
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ loadSettings()          â”‚
    â”‚                         â”‚
    â”‚ await loadData()        â”‚
    â”‚ â†’ Read data.json        â”‚
    â”‚                         â”‚
    â”‚ Object.assign(          â”‚
    â”‚   DEFAULT_SETTINGS,     â”‚
    â”‚   loaded data           â”‚
    â”‚ )                       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Settings Loaded Into    â”‚
    â”‚ this.settings object    â”‚
    â”‚                         â”‚
    â”‚ Available to:           â”‚
    â”‚ â€¢ Chat system           â”‚
    â”‚ â€¢ UI rendering          â”‚
    â”‚ â€¢ Event handlers        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Editor Context Tracking Flow

```
FILE CHANGES / CURSOR MOVES
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Obsidian Events Fired                   â”‚
â”‚ â€¢ active-leaf-change                    â”‚
â”‚ â€¢ editor-change                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ updateEditorContext()                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Get active markdown view              â”‚
â”‚ 2. Get editor from view                  â”‚
â”‚ 3. Get cursor position:                  â”‚
â”‚    { line: number, ch: number }          â”‚
â”‚ 4. Get current line content              â”‚
â”‚ 5. Get surrounding lines (Â±3 from cursor)
â”‚ 6. Build editorContext object:           â”‚
â”‚    {                                     â”‚
â”‚      fileName: string,                   â”‚
â”‚      lineContent: string,                â”‚
â”‚      surroundingLines: string[]          â”‚
â”‚    }                                     â”‚
â”‚ 7. Get current file content              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ editorContext Stored in Memory          â”‚
â”‚ (Available for next message)             â”‚
â”‚                                         â”‚
â”‚ When user sends message:                â”‚
â”‚ getEditorContextString() formats as:    â”‚
â”‚                                         â”‚
â”‚ --- Editor Context ---                  â”‚
â”‚ File: example.md                        â”‚
â”‚ Current line: 42                        â”‚
â”‚ Current line content: "..."             â”‚
â”‚                                         â”‚
â”‚ Surrounding context:                    â”‚
â”‚ ```                                     â”‚
â”‚  39: Line of code                       â”‚
â”‚  40: Line of code                       â”‚
â”‚  41: Line of code                       â”‚
â”‚  42: â†’ Current line (marked with â†’)     â”‚
â”‚  43: Line of code                       â”‚
â”‚  44: Line of code                       â”‚
â”‚  45: Line of code                       â”‚
â”‚ ```                                     â”‚
â”‚ --- End Context ---                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Chat History Management Flow

```
NEW CHAT STARTED
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚createNewSession()  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚{                   â”‚
    â”‚  id: Date.now(),   â”‚
    â”‚  title: "New chat" â”‚
    â”‚  timestamp: now,   â”‚
    â”‚  messages: []      â”‚
    â”‚}                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User sends message â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ After 2 messages (1 user,  â”‚
    â”‚ 1 bot), auto-generate titleâ”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ generateSessionTitle()      â”‚
    â”‚                            â”‚
    â”‚ Pattern matching:          â”‚
    â”‚ â€¢ "summarize" â†’ "ğŸ“ Summary"
    â”‚ â€¢ "translate" â†’ "ğŸŒ Trans" â”‚
    â”‚ â€¢ ends with "?" â†’ "â“ Q"   â”‚
    â”‚ â€¢ else â†’ keyword extract   â”‚
    â”‚ â€¢ default â†’ timestamp      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Message added to           â”‚
    â”‚ currentSession.messages[]  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ After each message:        â”‚
    â”‚ saveSettings()             â”‚
    â”‚                            â”‚
    â”‚ Persist to disk:           â”‚
    â”‚ settings.chatSessions =    â”‚
    â”‚   [current, ...rest]       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User clicks History Button â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚showChatHistoryView()       â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ renderChatHistorySections()â”‚
    â”‚                            â”‚
    â”‚ Organize by time:          â”‚
    â”‚ â€¢ Today                    â”‚
    â”‚ â€¢ Past 30 days             â”‚
    â”‚ â€¢ Older                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Display in UI:             â”‚
    â”‚ â€¢ Title                    â”‚
    â”‚ â€¢ Timestamp                â”‚
    â”‚ â€¢ Delete button            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â–¼                 â–¼
CLICK TO RESTORE   CLICK TO DELETE
    â”‚                 â”‚
    â”‚                 â–¼
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚deleteChat()   â”‚
    â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚         â”‚Filter array   â”‚
    â”‚         â”‚Remove by ID   â”‚
    â”‚         â”‚saveSettings() â”‚
    â”‚         â”‚Re-render      â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Load session messages â”‚
â”‚Display in chat       â”‚
â”‚Enable continue chat  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Initialization Sequence

```
PLUGIN LOAD (onload())
         â”‚
         â”œâ”€â†’ loadSettings()
         â”‚   â””â”€â†’ Load from disk
         â”‚
         â”œâ”€â†’ Check if API key exists
         â”‚   â””â”€â†’ initializeGeminiService()
         â”‚
         â”œâ”€â†’ registerCommands()
         â”‚   â”œâ”€â†’ toggle-vaultai-chat
         â”‚   â”œâ”€â†’ open-vaultai-chat
         â”‚   â”œâ”€â†’ vaultai-generate-at-cursor
         â”‚   â”œâ”€â†’ vaultai-complete-line
         â”‚   â”œâ”€â†’ vaultai-explain-selection
         â”‚   â”œâ”€â†’ vaultai-improve-selection
         â”‚   â””â”€â†’ custom-prompt-* (for each)
         â”‚
         â”œâ”€â†’ registerEventListeners()
         â”‚   â”œâ”€â†’ active-leaf-change
         â”‚   â””â”€â†’ editor-change
         â”‚
         â”œâ”€â†’ addSettingTab()
         â”‚   â””â”€â†’ Create GeminiChatbotSettingTab
         â”‚
         â”œâ”€â†’ addFloatingIcon()
         â”‚   â””â”€â†’ Create SVG icon in DOM
         â”‚       Position: bottom-right
         â”‚
         â””â”€â†’ addChatContainer()
             â””â”€â†’ createChatHeader()
             â”œâ”€â†’ createBotInfo()
             â”œâ”€â†’ createMessagesContainer()
             â”œâ”€â†’ createSuggestedActions()
             â”œâ”€â†’ createInputContainer()
             â”œâ”€â†’ addChatEventListeners()
             â”‚   â”œâ”€â†’ Send button click
             â”‚   â”œâ”€â†’ Prompts button click
             â”‚   â”œâ”€â†’ Mention button click
             â”‚   â”œâ”€â†’ Insert button click
             â”‚   â”œâ”€â†’ History button click
             â”‚   â”œâ”€â†’ More button click
             â”‚   â””â”€â†’ Text input handlers
             â””â”€â†’ addResizeFunctionality()
                 â””â”€â†’ Drag to resize
```

## File Structure & Import Dependencies

```
main.ts (2600+ lines)
â”œâ”€â”€ import { GeminiService }
â”‚   â””â”€â”€ src/services/GeminiService.ts
â”‚       â””â”€â”€ import { GoogleGenerativeAI }
â”‚           â””â”€â”€ @google/generative-ai
â”œâ”€â”€ import { LanguageSelectionModal }
â”‚   â””â”€â”€ src/modals/LanguageSelectionModal.ts
â”‚       â””â”€â”€ import { Modal, Setting }
â”‚           â””â”€â”€ obsidian
â”œâ”€â”€ import { FileSelectionModal }
â”‚   â””â”€â”€ src/modals/FileSelectionModal.ts
â”‚       â””â”€â”€ import { FuzzySuggestModal }
â”‚           â””â”€â”€ obsidian
â”œâ”€â”€ import { CustomPromptModal }
â”‚   â””â”€â”€ src/modals/CustomPromptModal.ts
â”‚       â””â”€â”€ import { Modal, Setting }
â”‚           â””â”€â”€ obsidian
â””â”€â”€ Obsidian Core Imports:
    â”œâ”€â”€ App
    â”œâ”€â”€ Notice
    â”œâ”€â”€ Plugin
    â”œâ”€â”€ PluginSettingTab
    â”œâ”€â”€ Setting
    â”œâ”€â”€ MarkdownView
    â”œâ”€â”€ Editor
    â””â”€â”€ MarkdownRenderer
```

## Session & Settings Data Hierarchy

```
Plugin Settings (saved to disk)
â”‚
â””â”€â”€ GeminiChatbotSettings {
    â”œâ”€â”€ apiKey: string (encrypted)
    â”‚   â””â”€â”€ Format: base64(reversed(key))
    â”‚
    â”œâ”€â”€ floatingPosition: {
    â”‚   â”œâ”€â”€ x: number
    â”‚   â””â”€â”€ y: number
    â”‚
    â”œâ”€â”€ isDocked: boolean
    â”‚
    â”œâ”€â”€ chatSessions: ChatSession[] {
    â”‚   â”œâ”€â”€ id: string
    â”‚   â”œâ”€â”€ title: string
    â”‚   â”œâ”€â”€ timestamp: number
    â”‚   â””â”€â”€ messages: ChatMessage[] {
    â”‚       â”œâ”€â”€ role: "user" | "bot"
    â”‚       â”œâ”€â”€ content: string
    â”‚       â””â”€â”€ timestamp: number
    â”‚   }
    â”‚
    â””â”€â”€ customPrompts: CustomPrompt[] {
        â”œâ”€â”€ id: string
        â”œâ”€â”€ name: string
        â”œâ”€â”€ description: string
        â””â”€â”€ prompt: string
            â””â”€â”€ May contain {{placeholders}}
```

## Error Handling Decision Tree

```
API Call to Gemini
    â”‚
    â–¼
Try-Catch Block
    â”‚
    â”œâ”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â†’ Render Response
    â”‚
    â””â”€ Error
        â”‚
        â”œâ”€ Contains "SAFETY" â”€â”€â”€â”€â”€â”€â”€â”€â†’ "Content safety violation"
        â”‚
        â”œâ”€ Contains "blocked"/"OTHER" â”€â”€â†’ "Blocked by filters"
        â”‚
        â”œâ”€ Contains "429"/"quota" â”€â”€â”€â†’ "Rate limit exceeded"
        â”‚                           (wait 1000ms)
        â”‚
        â”œâ”€ Contains "400" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ "Invalid request"
        â”‚
        â”œâ”€ Contains "401"/"403" â”€â”€â”€â”€â†’ "Check API key"
        â”‚
        â”œâ”€ Contains "500" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ "Service down"
        â”‚
        â””â”€ Unknown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ "Failed to get response"
            â”‚
            â–¼
        Show error in UI
        Log to console for debugging
```

## RAG Integration Points (Future)

```
Current State                    Proposed RAG Enhancement
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Manual @mention                  Automatic file discovery
    â”‚                                â”‚
    â”œâ”€â†’ Select file                 â”œâ”€â†’ Index vault
    â”œâ”€â†’ Read content                â”œâ”€â†’ Create embeddings
    â””â”€â†’ Store in memory             â””â”€â†’ Vector search

                                 File Upload
                                      â”‚
                                      â”œâ”€â†’ GeminiService.uploadFile()
                                      â”œâ”€â†’ Store file ID
                                      â””â”€â†’ Track in session

Single-file context              Multi-file context
    â”‚                                â”‚
    â””â”€â†’ Pass to Gemini              â”œâ”€â†’ Search uploaded files
                                     â”œâ”€â†’ Append relevant results
                                     â””â”€â†’ Pass to Gemini

Current Implementation           RAG-Enhanced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
30KB context limit       â†’    Unlimited via file API
Manual file selection    â†’    Automatic relevance
In-memory storage        â†’    Persistent file tracking
No cross-session memory  â†’    File ID caching
Linear search            â†’    Semantic search
```

